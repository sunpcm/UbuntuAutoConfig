---
- name: 1. Setup New Ubuntu Server
  hosts: servers        # å¯¹åº” hosts.ini é‡Œçš„ [servers] ç»„
  become: true          # 'become: true' æ„å‘³ç€ "åˆ‡æ¢åˆ° root (sudo)" æ¥æ‰§è¡Œä»»åŠ¡

  # -----------------------------------------------------------
  # å˜é‡ï¼šè¯·ä¿®æ”¹è¿™é‡Œçš„ç”¨æˆ·åä¸ºä½ æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·å
  # -----------------------------------------------------------
  vars:
    # è¿™ä¸ªç”¨æˆ·åæ˜¯ä½ è¦ä¸ºä¹‹é…ç½® Zshã€Homebrew çš„ç”¨æˆ·
    # å®ƒé€šå¸¸å’Œä½ çš„ ansible_user (SSHç™»å½•ç”¨æˆ·) æ˜¯åŒä¸€ä¸ª
    target_user: "{{ ansible_new_user }}"
    target_port: "{{ ansible_new_port }}"
    # æ³¨æ„ï¼šå¦‚æœæœåŠ¡å™¨åªæœ‰ root ç”¨æˆ·ï¼Œè¯·åœ¨ host.ini ä¸­è®¾ç½® ansible_user=root
    # playbook ä¼šè‡ªåŠ¨åˆ›å»º target_user å¹¶é…ç½®ç›¸å…³æƒé™ 

  # -----------------------------------------------------------
  # ä»»åŠ¡åˆ—è¡¨ï¼šAnsible ä¼šæŒ‰é¡ºåºæ‰§è¡Œ
  # -----------------------------------------------------------
  tasks:
    - name: "ä»»åŠ¡ 0: åˆ›å»ºæ™®é€šç”¨æˆ· {{ target_user }}"
      user:
        name: "{{ target_user }}"
        password: "*"  # ç¦ç”¨å¯†ç ç™»å½•ï¼Œåªå…è®¸å¯†é’¥è®¤è¯
        shell: /bin/bash  # ä¸´æ—¶ä½¿ç”¨ bashï¼Œåé¢ä¼šæ”¹ä¸º zsh
        create_home: yes
        home: "/home/{{ target_user }}"
        groups: sudo
        append: yes
      when: ansible_user == "root"  # åªæœ‰é€šè¿‡ root ç™»å½•æ—¶æ‰åˆ›å»ºç”¨æˆ·

    - name: "ä»»åŠ¡ 0.1: é…ç½® {{ target_user }} ç”¨æˆ·å…å¯† sudo"
      lineinfile:
        path: /etc/sudoers.d/{{ target_user }}
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
      when: ansible_user == "root"  # åªæœ‰é€šè¿‡ root ç™»å½•æ—¶æ‰é…ç½®

    - name: "ä»»åŠ¡ 1: é…ç½®å…å¯†ç™»å½• (å°†ä½ çš„ Mac å…¬é’¥å¤åˆ¶åˆ°æœåŠ¡å™¨ï¼Œåç»­æ— éœ€å¯†ç )"
      authorized_key:
        user: "{{ target_user }}"    # ä¸ºå“ªä¸ªç”¨æˆ·é…ç½®
        state: present               # ç¡®ä¿å¯†é’¥å­˜åœ¨
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}" # è‡ªåŠ¨æŸ¥æ‰¾ä½  Mac ä¸Šçš„å…¬é’¥

    - name: "ä»»åŠ¡ 2: æ›´æ–° APT ç¼“å­˜å¹¶å®‰è£…åŸºç¡€åŒ… (Zsh, Git, Build-Essential)"
      apt:
        name:
          - zsh
          - git
          - curl
          - build-essential   # ç¼–è¯‘ Homebrew ä¾èµ–éœ€è¦
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - ufw              # é˜²ç«å¢™
          - nginx            # Web æœåŠ¡å™¨
        state: present
        update_cache: yes

    - name: "ä»»åŠ¡ 3: åˆ›å»º Docker GPG å¯†é’¥ç›®å½•"
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: "ä»»åŠ¡ 4: ä¸‹è½½å¹¶æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥"
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: "ä»»åŠ¡ 5: æ·»åŠ  Docker APT æº"
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        update_cache: yes

    - name: "ä»»åŠ¡ 6: å®‰è£… Docker CE"
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: "ä»»åŠ¡ 7: å¯åŠ¨å¹¶å¯ç”¨ Docker æœåŠ¡"
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: "ä»»åŠ¡ 8: å°†ç”¨æˆ·æ·»åŠ åˆ° docker ç»„ (å… sudo ä½¿ç”¨ Docker)"
      user:
        name: "{{ target_user }}"
        groups: docker
        append: yes

    - name: "ä»»åŠ¡ 8.1: æç¤º Docker ç»„æƒé™è¯´æ˜"
      debug:
        msg: 
          - "ç”¨æˆ· {{ target_user }} å·²æ·»åŠ åˆ° docker ç»„"
          - "æ³¨æ„ï¼šç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•åæ‰èƒ½ä½¿ç”¨ docker å‘½ä»¤è€Œæ— éœ€ sudo"
          - "éƒ¨ç½²å®Œæˆåè¯·é‡æ–° SSH è¿æ¥ä»¥è·å¾— docker ç»„æƒé™"

    - name: "ä»»åŠ¡ 9: å¯åŠ¨å¹¶å¯ç”¨ Nginx æœåŠ¡"
      systemd:
        name: nginx
        enabled: yes
        state: started

    - name: "ä»»åŠ¡ 10: é…ç½®é˜²ç«å¢™ - å…ˆå…è®¸å½“å‰ SSH ç«¯å£ (è‡ªåŠ¨æ£€æµ‹)"
      ufw:
        rule: allow
        # ansible_port ä¼šè‡ªåŠ¨è·å–å½“å‰ Ansible SSH è¿æ¥æ‰€ç”¨çš„ç«¯å£å·
        port: "{{ ansible_port | default('22') }}"
        proto: tcp

    - name: "ä»»åŠ¡ 11: é…ç½®é˜²ç«å¢™ - å…è®¸æ–° SSH ç«¯å£ ({{ target_port }})"
      ufw:
        rule: allow
        port: '{{ target_port }}'
        proto: tcp

    - name: "ä»»åŠ¡ 12: é…ç½®é˜²ç«å¢™ - å…è®¸ HTTP (ç«¯å£ 80)"
      ufw:
        rule: allow
        port: '80'
        proto: tcp

    - name: "ä»»åŠ¡ 13: é…ç½®é˜²ç«å¢™ - å…è®¸ HTTPS (ç«¯å£ 443)"
      ufw:
        rule: allow
        port: '443'
        proto: tcp

    - name: "ä»»åŠ¡ 14: é…ç½®é˜²ç«å¢™ - å…è®¸å¼€å‘ç«¯å£ (8000-8999)"
      ufw:
        rule: allow
        port: '8000:8999'
        proto: tcp

    - name: "ä»»åŠ¡ 15: æ£€æŸ¥ Homebrew æ˜¯å¦å·²å®‰è£… (ç”¨æˆ·è·¯å¾„)"
      stat:
        path: "/home/{{ target_user }}/.linuxbrew/bin/brew"
      register: brew_stat_user
      become: true
      become_user: "{{ target_user }}"

    # - name: "ä»»åŠ¡ 16: å®‰è£… Homebrew (å¦‚æœæœªå®‰è£…)"
    #   shell: |
    #     cd /home/{{ target_user }}
    #     git clone https://github.com/Homebrew/brew.git .linuxbrew/Homebrew
    #     mkdir -p .linuxbrew/bin
    #     ln -sf ../Homebrew/bin/brew .linuxbrew/bin/brew
    #     eval "$(.linuxbrew/bin/brew shellenv)"
    #     .linuxbrew/bin/brew update --force --quiet
    #   args:
    #     creates: "/home/{{ target_user }}/.linuxbrew/bin/brew"
    #   when: not brew_stat_user.stat.exists
    #   become: true
    #   become_user: "{{ target_user }}"
    - name: "ä»»åŠ¡ 16: å®˜æ–¹å®‰è£…å™¨å®‰è£… Homebrewï¼ˆæ¨èæ–¹æ³•ï¼‰"
      shell: |
        NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      args:
        creates: "/home/{{ target_user }}/.linuxbrew/bin/brew"
      when: not brew_stat_user.stat.exists
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 16.1: éªŒè¯ Homebrew å®‰è£…å¹¶è·å–å®é™…å®‰è£…è·¯å¾„"
      shell: |
        # æŸ¥æ‰¾ Homebrew çš„å®é™…å®‰è£…ä½ç½®
        if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
          echo "SYSTEM_BREW_PATH=/home/linuxbrew/.linuxbrew/bin/brew"
        elif [ -f "/home/{{ target_user }}/.linuxbrew/bin/brew" ]; then
          echo "USER_BREW_PATH=/home/{{ target_user }}/.linuxbrew/bin/brew"
        elif command -v brew >/dev/null 2>&1; then
          echo "EXISTING_BREW_PATH=$(which brew)"
        else
          echo "NO_BREW_FOUND"
        fi
      register: brew_path_check
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 16.2: æ˜¾ç¤º Homebrew å®‰è£…çŠ¶æ€"
      debug:
        msg: "{{ brew_path_check.stdout }}"

    - name: "ä»»åŠ¡ 16.3: æ‰‹åŠ¨å®‰è£… Homebrew (å¦‚æœå®˜æ–¹å®‰è£…å™¨å¤±è´¥)"
      shell: |
        cd /home/{{ target_user }}
        git clone https://github.com/Homebrew/brew.git .linuxbrew/Homebrew
        mkdir -p .linuxbrew/bin
        ln -sf ../Homebrew/bin/brew .linuxbrew/bin/brew
        eval "$(.linuxbrew/bin/brew shellenv)"
        .linuxbrew/bin/brew update --force --quiet
      args:
        creates: "/home/{{ target_user }}/.linuxbrew/bin/brew"
      when: "'NO_BREW_FOUND' in brew_path_check.stdout"
      become: true
      become_user: "{{ target_user }}"


    - name: "ä»»åŠ¡ 17: æ£€æŸ¥ Oh My Zsh æ˜¯å¦å·²å®‰è£…"
      stat:
        path: "/home/{{ target_user }}/.oh-my-zsh"
      register: omz_stat
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 18: å®‰è£… Oh My Zsh (å¦‚æœæœªå®‰è£…)"
      shell: 'sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended'
      when: not omz_stat.stat.exists
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 19: å¤åˆ¶æœ¬åœ°æ¸…ç†ç‰ˆ .zshrc é…ç½®åˆ°æœåŠ¡å™¨ (è¦†ç›– Oh My Zsh é»˜è®¤é…ç½®)"
      copy:
        src: ".zshrc.server"    # ä½¿ç”¨æ¸…ç†è¿‡çš„ç‰ˆæœ¬
        dest: "/home/{{ target_user }}/.zshrc"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'
        backup: yes      # å¤‡ä»½åŸæœ‰çš„ .zshrc æ–‡ä»¶
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 19.1: å°† Homebrew è·¯å¾„æ·»åŠ åˆ° .zshrc"
      lineinfile:
        path: "/home/{{ target_user }}/.zshrc"
        line: 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"'
        regexp: '^.*eval.*brew shellenv.*'
        state: present
      become: true
      become_user: "{{ target_user }}"
      when: "'SYSTEM_BREW_PATH' in brew_path_check.stdout"

    - name: "ä»»åŠ¡ 19.2: å°†ç”¨æˆ· Homebrew è·¯å¾„æ·»åŠ åˆ° .zshrc (å¦‚æœå®‰è£…åœ¨ç”¨æˆ·ç›®å½•)"
      lineinfile:
        path: "/home/{{ target_user }}/.zshrc"
        line: 'eval "$(/home/{{ target_user }}/.linuxbrew/bin/brew shellenv)"'
        regexp: '^.*eval.*brew shellenv.*'
        state: present
      become: true
      become_user: "{{ target_user }}"
      when: "'USER_BREW_PATH' in brew_path_check.stdout"

    - name: "ä»»åŠ¡ 20: æ£€æŸ¥ zsh-autosuggestions æ’ä»¶æ˜¯å¦å·²å®‰è£…"
      stat:
        path: "/home/{{ target_user }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
      register: zsh_autosuggestions_stat
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 21: å®‰è£… zsh-autosuggestions æ’ä»¶"
      git:
        repo: "https://github.com/zsh-users/zsh-autosuggestions"
        dest: "/home/{{ target_user }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        clone: yes
        version: HEAD  # é¿å…é‡å¤ clone
      when: not zsh_autosuggestions_stat.stat.exists
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 21.1: æ£€æŸ¥ zsh-syntax-highlighting æ’ä»¶æ˜¯å¦å·²å®‰è£…"
      stat:
        path: "/home/{{ target_user }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
      register: zsh_syntax_highlighting_stat
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 21.2: å®‰è£… zsh-syntax-highlighting æ’ä»¶"
      git:
        repo: "https://github.com/zsh-users/zsh-syntax-highlighting"
        dest: "/home/{{ target_user }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
        clone: yes
        version: HEAD
      when: not zsh_syntax_highlighting_stat.stat.exists
      become: true
      become_user: "{{ target_user }}"

    - name: "ä»»åŠ¡ 22: æ›´æ”¹ {{ target_user }} çš„é»˜è®¤ Shell ä¸º Zsh"
      user:
        name: "{{ target_user }}"
        shell: /usr/bin/zsh
        
    - name: "ä»»åŠ¡ 23: å®‰è£…å¿…è¦çš„å­—ä½“ (æ”¯æŒ agnoster ä¸»é¢˜)"
      apt:
        name:
          - fonts-powerline
          - fonts-firacode  # ä½¿ç”¨æ ‡å‡†åŒ…åä»¥ç¡®ä¿å…¼å®¹æ€§
        state: present
        update_cache: no

    - name: "ä»»åŠ¡ 24: ä¿®æ”¹ SSH ç«¯å£ä¸º {{ target_port }}"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?Port .+'
        line: 'Port {{ target_port }}'
        validate: 'sshd -t -f %s'
      notify: "Restart sshd"
      tags: [sshd_config]

    - name: "ä»»åŠ¡ 25: ç¦ç”¨ root ç”¨æˆ· SSH ç™»å½•"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin .+'
        line: 'PermitRootLogin no'
        validate: 'sshd -t -f %s'
      notify: "Restart sshd"
      tags: [sshd_config]
        
    - name: "ä»»åŠ¡ 26: ç¦ç”¨å¯†ç ç™»å½•"
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication .+'
        line: 'PasswordAuthentication no'
        validate: 'sshd -t -f %s'
      notify: "Restart sshd"
      tags: [sshd_config]

    # SSH å®‰å…¨éªŒè¯ï¼šç¡®ä¿æ–°ç«¯å£çœŸæ­£å¯ç”¨
    - name: "ä»»åŠ¡ 27: å¼ºåˆ¶æ‰§è¡Œ SSH é‡å¯ (ç­‰å¾…å¤„ç†å®Œæˆ)"
      meta: flush_handlers
      
    - name: "ä»»åŠ¡ 28: éªŒè¯ SSH ç«¯å£ {{ target_port }} æ˜¯å¦æ­£å¸¸ç›‘å¬"
      wait_for:
        port: "{{ target_port }}"
        host: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}"
        delay: 3
        timeout: 30
        msg: "SSH ç«¯å£ {{ target_port }} åœ¨ 30 ç§’å†…æœªèƒ½æ­£å¸¸å¯åŠ¨ï¼Œè¯·æ£€æŸ¥é…ç½®"
      register: wait_for_target_port  # æ³¨å†Œå˜é‡ä»¥ä¾›åç»­ä½¿ç”¨
      delegate_to: localhost
      when: ansible_connection != 'local'  # æœ¬åœ°æ‰§è¡Œæ—¶è·³è¿‡

    - name: "ä»»åŠ¡ 29: å…³é—­ 22 ç«¯å£ (ç¡®è®¤ {{ target_port }} å¯ç”¨å)"
      ufw:
        rule: deny
        port: '22'
        proto: tcp
        delete: yes
      when: wait_for_target_port is succeeded and ansible_connection != 'local'

    - name: "ä»»åŠ¡ 30: SSH ç«¯å£åˆ‡æ¢å®Œæˆæç¤º"
      debug:
        msg:
          - "âœ… SSH ç«¯å£å·²æˆåŠŸåˆ‡æ¢åˆ° {{ target_port }}"
          - "âš ï¸  é‡è¦ï¼šä¸‹æ¬¡è¿æ¥è¯·ä½¿ç”¨ ssh -p {{ target_port }} {{ target_user }}@{{ ansible_host }}"
          - "ğŸ”’ å®‰å…¨ï¼š22 ç«¯å£å·²è‡ªåŠ¨å…³é—­ï¼Œåªæœ‰ {{ target_port }} ç«¯å£å¯ç”¨"

    # æœ€é‡è¦ï¼šUFW å¯ç”¨å¿…é¡»æ”¾åœ¨æœ€åï¼Œé¿å…ä¸­æ–­è¿æ¥
    - name: "ä»»åŠ¡ 31: é…ç½®é˜²ç«å¢™ - å¯ç”¨ UFW (æ‰€æœ‰é…ç½®å®Œæˆå)"
      ufw:
        state: enabled
        policy: deny
        direction: incoming

  # -----------------------------------------------------------
  # Handlersï¼šä»…åœ¨è¢« 'notify' è§¦å‘æ—¶è¿è¡Œ
  # -----------------------------------------------------------
  handlers:
    - name: "Restart sshd"
      service:
        name: sshd
        state: restarted
